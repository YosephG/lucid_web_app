(function(){(this||window).webpackJsonp.registerAbsMids({"esri/views/3d/layers/PointCloudWorker":1461,"esri/views/3d/webgl-engine/lib/RenderSlot":1494,"esri/views/3d/webgl-engine/lib/RenderPass":1510,"esri/views/layers/LayerView":1512,"esri/views/3d/layers/LayerView3D":1537,"esri/views/3d/layers/i3s/I3SBinaryReader":1564,"esri/views/3d/support/orientedBoundingBox":1565,"esri/symbols/support/unitConversionUtils":1569,"esri/views/3d/layers/support/layerViewUpdatingProperties":1634,"esri/views/3d/layers/support/symbolColorUtils":1646,"esri/views/3d/layers/i3s/LEPCC":1651,"esri/views/3d/layers/i3s/I3SUtil":1657,"esri/views/3d/support/dito":1669,"esri/views/3d/layers/i3s/PointCloudRendererUtil":1812,"esri/views/3d/layers/i3s/IdleQueue":1847,"esri/views/3d/layers/PointCloudLayerView3D":2316,"esri/views/3d/layers/i3s/LoDUtil":2317,"esri/views/3d/layers/i3s/PagedNodeIndex":2318,"esri/views/3d/layers/i3s/PointRenderer":2319,"dojo/text!esri/views/3d/layers/i3s/PointCloudPointRenderer.xml":2320})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[68],{1461:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(7),r(22),r(1564),r(1651),r(1812),r(49),r(99)],void 0===(i=function(e,t,r,n,i,o,a,s,u){var d=function(){function e(){}return e.prototype.process=function(e){var t=this.transform(e);return r.resolve({result:t,transferList:[t.rgb]})},e.prototype.transform=function(e){var t=this.readGeometry(e.schema,e.geometryBuffer),r=a.evaluateRenderer(e.rendererInfo,e.primaryAttribute,e.modulationAttribute,t,t.length/3);this._applyElevationOffsetInPlace(t,e.elevationOffset);var i=this._transformCoordinates(t,e.obb,n.fromJSON(e.inSR),n.fromJSON(e.outSR));return{obb:e.obb,points:i,rgb:r.buffer}},e.prototype.readGeometry=function(e,t){if(null==e.encoding||""===e.encoding){for(var r=i.createGeometryDataIndex(t,e,!1),n=i.createTypedView(t,r.vertexAttributes.position),a=r.header.fields,s=[a.offsetX,a.offsetY,a.offsetZ],u=[a.scaleX,a.scaleY,a.scaleZ],d=n.length/3,l=new Float64Array(3*d),c=0;c<d;c++)l[3*c]=n[3*c]*u[0]+s[0],l[3*c+1]=n[3*c+1]*u[1]+s[1],l[3*c+2]=n[3*c+2]*u[2]+s[2];return l}if("lepcc-xyz"===e.encoding)return o.decodeXYZ(t).result},e.prototype._transformCoordinates=function(e,t,r,n){var i=e.length/3;if(!u.bufferToBuffer(e,r,0,e,n,0,i))throw Error("Can't reproject");var o=s.vec3.createFrom(t.center[0],t.center[1],t.center[2]),a=s.vec3.create(),d=s.vec3.create();s.quat4.conjugate(t.quaternion,l);for(var c=new Float32Array(3*i),f=0;f<i;f++)a[0]=e[3*f]-o[0],a[1]=e[3*f+1]-o[1],a[2]=e[3*f+2]-o[2],s.quat4.multiplyVec3(l,a,d),t.halfSize[0]=Math.max(t.halfSize[0],Math.abs(d[0])),t.halfSize[1]=Math.max(t.halfSize[1],Math.abs(d[1])),t.halfSize[2]=Math.max(t.halfSize[2],Math.abs(d[2])),c[3*f]=a[0],c[3*f+1]=a[1],c[3*f+2]=a[2];return c},e.prototype._applyElevationOffsetInPlace=function(e,t){var r=e.length/3;if(0!==t)for(var n=0;n<r;n++)e[3*n+2]+=t},e}(),l=s.quat4.create();return d}.apply(null,n))||(e.exports=i)},1494:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){var r;return function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.INTERNAL_MATERIAL=1]="INTERNAL_MATERIAL",e[e.STENCIL_MATERIAL=2]="STENCIL_MATERIAL",e[e.OPAQUE_TERRAIN=3]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=4]="OPAQUE_MATERIAL",e[e.OPAQUE_EXTERNAL=5]="OPAQUE_EXTERNAL",e[e.TRANSPARENT_MATERIAL=6]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_EXTERNAL=7]="TRANSPARENT_EXTERNAL",e[e.TRANSPARENT_TERRAIN=8]="TRANSPARENT_TERRAIN",e[e.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_HIGHLIGHT=10]="POSTPROCESSING_HIGHLIGHT",e[e.POSTPROCESSING_ATMOSPHERE_OPAQUE=11]="POSTPROCESSING_ATMOSPHERE_OPAQUE",e[e.POSTPROCESSING_ATMOSPHERE_TRANSPARENT=12]="POSTPROCESSING_ATMOSPHERE_TRANSPARENT",e[e.POSTPROCESSING_EXTERNAL=13]="POSTPROCESSING_EXTERNAL",e[e.HUDMATERIAL1=14]="HUDMATERIAL1",e[e.HUDMATERIAL2=15]="HUDMATERIAL2",e[e.LINE_CALLOUTS=16]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",e[e.MAX_SLOTS=18]="MAX_SLOTS"}(r||(r={})),r}.apply(null,n))||(e.exports=i)},1510:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){var r;return function(e){e[e.MATERIAL=0]="MATERIAL",e[e.MATERIAL_DEPTH=1]="MATERIAL_DEPTH",e[e.MATERIAL_NORMAL=2]="MATERIAL_NORMAL",e[e.MATERIAL_DEPTH_SHADOWMAP=3]="MATERIAL_DEPTH_SHADOWMAP",e[e.MATERIAL_HIGHLIGHT=4]="MATERIAL_HIGHLIGHT",e[e.MAX_PASS=5]="MAX_PASS"}(r||(r={})),r}.apply(null,n))||(e.exports=i)},1512:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(2),r(0),r(4),r(29),r(15),r(141),r(9),r(120),r(7),r(1)],void 0===(i=function(e,t,r,n,i,o,a,s,u,d,l,c){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.handles=new a,t.layer=null,t.parent=null,t.view=null,t}return r(t,e),t.prototype.initialize=function(){var e=this;this.addResolvingPromise(this.layer),this.when().catch(function(t){if("layerview:create-error"!==t.name){var r=e.layer&&e.layer.id||"no id",n=e.layer&&e.layer.title||"no title";return u.getLogger(e.declaredClass).error("#resolve()","Failed to resolve layer view (layer title: '"+n+"', id: '"+r+"')",t),l.reject(t)}})},t.prototype.destroy=function(){this.layer=this.view=this.parent=null},Object.defineProperty(t.prototype,"suspended",{get:function(){return!this.canResume()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.suspended&&this.isUpdating()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"visible",{get:function(){return!0===this.get("layer.visible")},set:function(e){void 0!==e?this._override("visible",e):this._clearOverride("visible")},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"fullOpacity",{get:function(){var e=function(e){return null!=e?e:1};return e(this.get("layer.opacity"))*e(this.get("parent.fullOpacity"))},enumerable:!0,configurable:!0}),t.prototype.canResume=function(){return!this.get("parent.suspended")&&this.get("view.ready")&&this.get("layer.loaded")&&this.visible||!1},t.prototype.isUpdating=function(){return!1},n([c.property()],t.prototype,"layer",void 0),n([c.property()],t.prototype,"parent",void 0),n([c.property({readOnly:!0,dependsOn:["view","visible","layer.loaded","parent.suspended"]})],t.prototype,"suspended",null),n([c.property({type:Boolean,dependsOn:["suspended"],readOnly:!0})],t.prototype,"updating",null),n([c.property()],t.prototype,"view",void 0),n([c.property({dependsOn:["layer.visible"]})],t.prototype,"visible",null),n([c.property({dependsOn:["layer.opacity","parent.fullOpacity"]})],t.prototype,"fullOpacity",null),n([c.subclass("esri.views.layers.LayerView")],t)}(c.declared(i,o,s,d))}.apply(null,n))||(e.exports=i)},1537:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(2),r(0),r(7),r(16),r(1),r(476),r(1512)],void 0===(i=function(e,t,r,n,i,o,a,s,u){return function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.supportsHeightUnitConversion=!1,t}return r(t,e),t.prototype.postscript=function(e){this.inherited(arguments),s.mayHaveHeightModelInfo(this.layer)&&this.addResolvingPromise(this._validateHeightModelInfo())},t.prototype._validateHeightModelInfo=function(){var e=this;return i.create(function(t,r){o.whenFalseOnce(e.view.defaultsFromMap,"isHeightModelInfoSearching",function(){var n=s.rejectLayerError(e.layer,e.view.heightModelInfo,e.supportsHeightUnitConversion);n?r(n):t()})})},n([a.property()],t.prototype,"view",void 0),n([a.subclass("esri.views.3d.layers.LayerView3D")],t)}(a.declared(u))}.apply(null,n))||(e.exports=i)},1564:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(8),r(5),r(9),r(1651)],void 0===(i=function(e,t,r,n,i,o){function a(e,t,n){for(var i="",o=0;o<n;){var a=e[t+o];if(a<128)i+=String.fromCharCode(a),o++;else if(a>=192&&a<224){if(o+1>=n)throw new r("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var s=(31&a)<<6|63&e[t+o+1];i+=String.fromCharCode(s),o+=2}else if(a>=224&&a<240){if(o+2>=n)throw new r("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");s=(15&a)<<12|(63&e[t+o+1])<<6|63&e[t+o+2];i+=String.fromCharCode(s),o+=3}else{if(!(a>=240&&a<248))throw new r("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");if(o+3>=n)throw new r("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");if((s=(7&a)<<18|(63&e[t+o+1])<<12|(63&e[t+o+2])<<6|63&e[t+o+3])>=65536){var u=55296+(s-65536>>10),d=56320+(1023&s);i+=String.fromCharCode(u,d)}else i+=String.fromCharCode(s);o+=4}}return i}function s(e,r){for(var n={byteOffset:0,byteCount:0,fields:Object.create(null)},i=0,o=0;o<r.length;o++){var a=r[o],s=a.valueType||a.type,u=t.valueType2ArrayBufferReader[s];n.fields[a.property]=u(e,i),i+=t.valueType2TypedArrayClassMap[s].BYTES_PER_ELEMENT}return n.byteCount=i,n}function u(e,t,n){var i,o,s=[],u=0;for(o=0;o<e;o+=1){if((i=t[o])>0){if(s.push(a(n,u,i-1)),0!==n[u+i-1])throw new r("string-array-error","Invalid string array: missing null termination.")}else s.push(null);u+=i}return s}function d(e,r){return new(0,t.valueType2TypedArrayClassMap[r.valueType])(e,r.byteOffset,r.count*r.valuesPerElement)}function l(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function c(e,t,i){for(var o=null!=t.header?s(e,t.header):{byteOffset:0,byteCount:0,fields:{count:i}},a={header:o,byteOffset:o.byteCount,byteCount:0,entries:Object.create(null)},u=o.byteCount,d=0;d<t.ordering.length;d++){var l=t.ordering[d],c=n.clone(t[l]);if(c.count=o.fields.count,"String"===c.valueType){if(c.byteOffset=u,c.byteCount=o.fields[l+"ByteCount"],"UTF-8"!==c.encoding)throw new r("unsupported-encoding","Unsupported String encoding.",{encoding:c.encoding})}else{if(!p(c.valueType))throw new r("unsupported-value-type","Unsupported binary valueType",{valueType:c.valueType});var f=h(c.valueType);u+=u%f!=0?f-u%f:0,c.byteOffset=u,c.byteCount=f*c.valuesPerElement*c.count}u+=c.byteCount,a.entries[l]=c}return a.byteCount=u-a.byteOffset,a}function f(e,t,n){if(t!==e&&v.error("Invalid "+n+" buffer size\n expected: "+e+", actual: "+t+")"),t<e)throw new r("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function p(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function h(e){return p(e)&&t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT}Object.defineProperty(t,"__esModule",{value:!0});var v=i.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");t.readHeader=s,t.readStringArray=u,t.createTypedView=d,t.createRawView=l,t.createAttributeDataIndex=c,t.createGeometryDataIndex=function(e,t,r){var i=s(e,t&&t.header),o=i.byteCount,a={header:i,byteOffset:i.byteCount,byteCount:0,vertexAttributes:n.clone(t.vertexAttributes)},u=a.vertexAttributes;r||null==u.region||delete u.region;for(var d=i.fields,l=null!=d.vertexCount?d.vertexCount:d.count,c=0;c<t.ordering.length;c++){var p=t.ordering[c];null!=u[p]&&(u[p].byteOffset=o,u[p].count=l,o+=h(u[p].valueType)*u[p].valuesPerElement*l)}var v=d.faceCount;if(t.faces&&v){a.faces=n.clone(t.faces);var g=a.faces;for(c=0;c<t.ordering.length;c++){var y=t.ordering[c];null!=g[y]&&(g[y].byteOffset=o,g[y].count=v,o+=h(g[y].valueType)*g[y].valuesPerElement*v)}}var m=d.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&m){a.featureAttributes=n.clone(t.featureAttributes);var _=a.featureAttributes;for(c=0;c<t.featureAttributeOrder.length;c++){var b=t.featureAttributeOrder[c];_[b].byteOffset=o,_[b].count=m;var S=h(_[b].valueType);"UInt64"===_[b].valueType&&(S=8),o+=S*_[b].valuesPerElement*m}}return f(o,e.byteLength,"geometry"),a.byteCount=o-a.byteOffset,a},t.readBinaryAttribute=function(e,t,n){if("lepcc-rgb"===e.encoding)return o.decodeRGB(t);if("lepcc-intensity"===e.encoding)return o.decodeIntensity(t);if(null!=e.encoding&&""!==e.encoding)throw new r("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(v.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(v.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var i=c(t,e,n);f(i.byteOffset+i.byteCount,t.byteLength,"attribute");var a=i.entries.attributeValues||i.entries.objectIds;if(a){if("String"===a.valueType){var s=i.entries.attributeByteCounts,p=d(t,s),h=l(t,a);return u(s.count,p,h)}return d(t,a)}throw new r("bad-attribute-storage-info","Bad attributeStorageInfo specification.")},t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=p,t.getBytesPerValue=h}.apply(null,n))||(e.exports=i)},1565:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(474),r(49),r(1669),r(1513)],void 0===(i=function(e,t,r,n,i,o){function a(e,t,r){return{center:n.vec3d.createFrom(e[0],e[1],e[2]),halfSize:l.createFrom(t[0],t[1],t[2]),quaternion:d.createFrom(r[0],r[1],r[2],r[3])}}function s(e,t){var r=o.plane.distance(t,e.center),n=u(e,t);return r>n?1:r<-n?-1:0}function u(e,t){d.conjugate(e.quaternion,f),d.multiplyVec3(f,t,p);var r=e.halfSize;return Math.abs(p[0]*r[0])+Math.abs(p[1]*r[1])+Math.abs(p[2]*r[2])}Object.defineProperty(t,"__esModule",{value:!0});var d=n.quat4,l=n.vec3,c=n.mat3d,f=d.create(),p=l.create(),h=l.create(),v=c.create(),g=function(){return function(e){var t=56*e;this.buffer=new ArrayBuffer(t),this.obbs=new Array(e);for(var r=0;r<e;r++)this.obbs[r]={center:new Float64Array(this.buffer,56*r+0,3),halfSize:new Float32Array(this.buffer,56*r+24,3),quaternion:new Float32Array(this.buffer,56*r+36,4)}}}();t.ObbArray=g,t.create=a,t.clone=function(e){return a(e.center,e.halfSize,e.quaternion)},t.set=function(e,t){n.vec3d.set(e.center,t.center),n.vec3.set(e.halfSize,t.halfSize),n.quat4.set(e.quaternion,t.quaternion)},t.compute=function(e,t){return t||(t=a([0,0,0],[-1,-1,-1],[0,0,0,1])),i.computeOBB(e,t),t},t.intersectPlane=s,t.toAaBoundingBox=function(e,t){t||(t=r.create());var n=d.toMat3(e.quaternion,v),i=e.halfSize[0]*Math.abs(n[0])+e.halfSize[1]*Math.abs(n[3])+e.halfSize[2]*Math.abs(n[6]),o=e.halfSize[0]*Math.abs(n[1])+e.halfSize[1]*Math.abs(n[4])+e.halfSize[2]*Math.abs(n[7]),a=e.halfSize[0]*Math.abs(n[2])+e.halfSize[1]*Math.abs(n[5])+e.halfSize[2]*Math.abs(n[8]);return t[0]=e.center[0]-i,t[1]=e.center[1]-o,t[2]=e.center[2]-a,t[3]=e.center[0]+i,t[4]=e.center[1]+o,t[5]=e.center[2]+a,t},t.minimumDistancePlane=function(e,t){return o.plane.distance(t,e.center)-u(e,t)},t.maximumDistancePlane=function(e,t){return o.plane.distance(t,e.center)+u(e,t)},t.isVisible=function(e,t){return s(e,t[0])<=0&&s(e,t[1])<=0&&s(e,t[2])<=0&&s(e,t[3])<=0&&s(e,t[4])<=0&&s(e,t[5])<=0},t.intersectLine=function(e,t,r,i){void 0===i&&(i=0),d.conjugate(e.quaternion,f),n.vec3.subtract(t,e.center,p);for(var o=d.multiplyVec3(f,p,p),a=d.multiplyVec3(f,r,h),s=-1/0,u=1/0,l=0;l<3;l++)if(Math.abs(a[l])>1e-6){var c=(i+e.halfSize[l]-o[l])/a[l],v=(-i-e.halfSize[l]-o[l])/a[l];s=Math.max(s,Math.min(c,v)),u=Math.min(u,Math.max(c,v))}else if(o[l]>e.halfSize[l]+i||o[l]<-e.halfSize[l]-i)return!1;return s<=u}}.apply(null,n))||(e.exports=i)},1569:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(481)],void 0===(i=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.supportsUnit=function(e){return null!=r.meterIn[e]},t.getMetersPerUnit=function(e){return 1/(r.meterIn[e]||1)}}.apply(null,n))||(e.exports=i)},1634:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.updatingPercentageValue={value:100,readOnly:!0},t.updatingPercentage={dependsOn:["updating","updatingPercentageValue"],readOnly:!0,value:0,get:function(){return this.updating?this.updatingPercentageValue:0}}}.apply(null,n))||(e.exports=i)},1646:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.encodeSymbolColor=function(e,t,r){if(null==e||"ignore"===t)return r[0]=255,r[1]=255,r[2]=255,void(r[3]=255);r[0]=Math.floor(255*e[0]),r[1]=Math.floor(255*e[1]),r[2]=Math.floor(255*e[2]);var n=Math.floor(85*e[3]);r[3]=0===n?0:"tint"===t?n:"replace"===t?n+85:n+170}}.apply(null,n))||(e.exports=i)},1651:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(8)],void 0===(i=function(e,t,r){function n(e,t,r){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,r+l.identifierOffset,l.identifierLength)),version:t.getUint16(r+l.versionOffset,d),checksum:t.getUint32(r+l.checksumOffset,d)}}function i(e,t){return{sizeLo:e.getUint32(t+c.sizeLo,d),sizeHi:e.getUint32(t+c.sizeHi,d),minX:e.getFloat64(t+c.minX,d),minY:e.getFloat64(t+c.minY,d),minZ:e.getFloat64(t+c.minZ,d),maxX:e.getFloat64(t+c.maxX,d),maxY:e.getFloat64(t+c.maxY,d),maxZ:e.getFloat64(t+c.maxZ,d),errorX:e.getFloat64(t+c.errorX,d),errorY:e.getFloat64(t+c.errorY,d),errorZ:e.getFloat64(t+c.errorZ,d),count:e.getUint32(t+c.count,d),reserved:e.getUint32(t+c.reserved,d)}}function o(e,t,r){var n=[];t=a(e,t,n);for(var i=[],o=0;o<n.length;o++){i.length=0,t=a(e,t,i);for(var s=0;s<i.length;s++)r.push(i[s]+n[o])}return t}function a(e,t,n){var i=new DataView(e,t),o=i.getUint8(0),a=31&o,s=!!(32&o),u=(192&o)>>6,l=0;if(0===u)l=i.getUint32(1,d),t+=5;else if(1===u)l=i.getUint16(1,d),t+=3;else{if(2!==u)throw new r("lepcc-decode-error","Bad count type");l=i.getUint8(1),t+=2}if(s)throw new r("lepcc-decode-error","LUT not implemented");for(var c=Math.ceil(l*a/8),f=new Uint8Array(e,t,c),p=0,h=0,v=0,g=-1>>>32-a,y=0;y<l;y++){for(;h<a;)p|=f[v]<<h,h+=8,v+=1;n[y]=p&g,p>>>=a,(h-=a)+a>32&&(p|=f[v-1]>>8-h)}return t+v}function s(e,t){return{sizeLo:e.getUint32(t+f.sizeLo,d),sizeHi:e.getUint32(t+f.sizeHi,d),count:e.getUint32(t+f.count,d),colorMapCount:e.getUint16(t+f.colorMapCount,d),lookupMethod:e.getUint8(t+f.lookupMethod),compressionMethod:e.getUint8(t+f.compressionMethod)}}function u(e,t){return{sizeLo:e.getUint32(t+p.sizeLo,d),sizeHi:e.getUint32(t+p.sizeHi,d),count:e.getUint32(t+p.count,d),scaleFactor:e.getUint16(t+p.scaleFactor,d),bitsPerPoint:e.getUint8(t+p.bitsPerPoint),reserved:e.getUint8(t+p.reserved)}}Object.defineProperty(t,"__esModule",{value:!0});var d=!0,l={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16},c={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};t.decodeXYZ=function(e){var t=new DataView(e,0),a=0,s=n(e,t,a),u=s.identifier,d=s.version;if(a+=l.byteCount,"LEPCC     "!==u)throw new r("lepcc-decode-error","Bad identifier");if(d>1)throw new r("lepcc-decode-error","Unknown version");var f=i(t,a);if(a+=c.byteCount,f.sizeHi*Math.pow(2,32)+f.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var p=new Float64Array(3*f.count),h=[],v=[],g=[],y=[];if((a=o(e,a=o(e,a=o(e,a=o(e,a,h),v),g),y))!==e.byteLength)throw new r("lepcc-decode-error","Bad length");for(var m=0,_=0,b=0;b<h.length;b++){_+=h[b];for(var S=0,w=0;w<v[b];w++){S+=g[m];var P=y[m];p[3*m]=Math.min(f.maxX,f.minX+2*f.errorX*S),p[3*m+1]=Math.min(f.maxY,f.minY+2*f.errorY*_),p[3*m+2]=Math.min(f.maxZ,f.minZ+2*f.errorZ*P),m++}}return{errorX:f.errorX,errorY:f.errorY,errorZ:f.errorZ,result:p}};var f={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};t.decodeRGB=function(e){var t=new DataView(e,0),i=0,o=n(e,t,i),a=o.identifier,u=o.version;if(i+=l.byteCount,"ClusterRGB"!==a)throw new r("lepcc-decode-error","Bad identifier");if(u>1)throw new r("lepcc-decode-error","Unknown version");var d=s(t,i);if(i+=f.byteCount,d.sizeHi*Math.pow(2,32)+d.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");if(2!==d.lookupMethod&&1!==d.lookupMethod||0!==d.compressionMethod){if(0===d.lookupMethod&&0===d.compressionMethod){if(3*d.count+i!==e.byteLength||0!==d.colorMapCount)throw new r("lepcc-decode-error","Bad count");return new Uint8Array(e,i).slice()}if(d.lookupMethod<=2&&1===d.compressionMethod){if(i+3!==e.byteLength||1!==d.colorMapCount)throw new r("lepcc-decode-error","Bad count");for(var c=t.getUint8(i),p=t.getUint8(i+1),h=t.getUint8(i+2),v=new Uint8Array(3*d.count),g=0;g<d.count;g++)v[3*g]=c,v[3*g+1]=p,v[3*g+2]=h;return v}throw new r("lepcc-decode-error","Bad method "+d.lookupMethod+","+d.compressionMethod)}if(3*d.colorMapCount+d.count+i!==e.byteLength||d.colorMapCount>256)throw new r("lepcc-decode-error","Bad count");var y=new Uint8Array(e,i,3*d.colorMapCount),m=new Uint8Array(e,i+3*d.colorMapCount,d.count);for(v=new Uint8Array(3*d.count),g=0;g<d.count;g++){var _=m[g];v[3*g]=y[3*_],v[3*g+1]=y[3*_+1],v[3*g+2]=y[3*_+2]}return v};var p={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};t.decodeIntensity=function(e){var t=new DataView(e,0),i=0,o=n(e,t,i),s=o.identifier,d=o.version;if(i+=l.byteCount,"Intensity "!==s)throw new r("lepcc-decode-error","Bad identifier");if(d>1)throw new r("lepcc-decode-error","Unknown version");var c=u(t,i);if(i+=p.byteCount,c.sizeHi*Math.pow(2,32)+c.sizeLo!==e.byteLength)throw new r("lepcc-decode-error","Bad size");var f=new Uint16Array(c.count);if(8===c.bitsPerPoint){if(c.count+i!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(var h=new Uint8Array(e,i,c.count),v=0;v<c.count;v++)f[v]=h[v]*c.scaleFactor}else if(16===c.bitsPerPoint){if(2*c.count+i!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(h=new Uint16Array(e,i,c.count),v=0;v<c.count;v++)f[v]=h[v]*c.scaleFactor}else{if(a(e,i,h=[])!==e.byteLength)throw new r("lepcc-decode-error","Bad size");for(v=0;v<c.count;v++)f[v]=h[v]*c.scaleFactor}return f}}.apply(null,n))||(e.exports=i)},1657:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(21),r(8),r(7),r(20),r(22),r(30),r(102),r(52),r(1564),r(99),r(1646)],void 0===(i=function(e,t,r,n,i,o,a,s,u,d,l,c,f){function p(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function h(e,t){var r,n=t[0],i=t[1],o=t[2],a=t[3],s=0;n<e[0]&&(s+=(r=e[0]-n)*r);i<e[1]&&(s+=(r=e[1]-i)*r);o<e[2]&&(s+=(r=e[2]-o)*r);n>e[3]&&(s+=(r=n-e[3])*r);i>e[4]&&(s+=(r=i-e[4])*r);o>e[5]&&(s+=(r=o-e[5])*r);if(s>a*a)return 0;if(s>0)return 1;var u=1/0;return n-e[0]<u&&(u=n-e[0]),i-e[1]<u&&(u=i-e[1]),o-e[2]<u&&(u=o-e[2]),e[3]-n<u&&(u=e[3]-n),e[4]-i<u&&(u=e[4]-i),e[5]-o<u&&(u=e[5]-o),u>a?2:1}function v(e,t,r){for(var n=[],i=r&&r.missingFields,o=r&&r.originalFields,a=0,s=e;a<s.length;a++){for(var u=s[a],d=u.toLowerCase(),l=!1,c=0,f=t;c<f.length;c++){var p=f[c];if(d===p.name.toLowerCase()){n.push(p.name),l=!0,o&&o.push(u);break}}!l&&i&&i.push(u)}return n}function g(e,t,r){if(null!=e.maxRecordCount&&t.length>e.maxRecordCount){var o=function(e,t){for(var r=e.length,n=Math.ceil(r/t),i=[],o=0;o<n;o++){var a=Math.floor(r*o/n),s=Math.floor(r*(o+1)/n);i.push(e.slice(a,s))}return i}(t,e.maxRecordCount);return i.all(o.map(function(t){return g(e,t,r)})).then(_)}var a=new d({objectIds:t,outFields:r,orderByFields:[e.objectIdField]});return new u(e.parsedUrl.path).execute(a).then(function(e){return e&&e.features&&e.features.length===t.length?e.features.map(function(e){return e.attributes}):i.reject(new n("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer"))})}function y(e,t,a,s,u){for(var d=[],c=0;c<t.attributeData.length;c++){var f=t.attributeData[c],p=e[c];if(p&&-1!==s.indexOf(p.name)){var h=o.makeAbsolute(f.href,t.baseUrl);d.push({url:h,storageInfo:p})}}return i.eachAlways(d.map(function(e){return r(e.url,{responseType:"array-buffer"}).then(function(t){return l.readBinaryAttribute(e.storageInfo,t.data)})})).then(function(e){var t=[];if(!u.ignoreUnavailableFields&&e.some(function(e){return null==e.value})){for(var r=[],o=0;o<e.length;o++)null==e[o].value&&r.push({name:d[o].storageInfo.name,error:e[o].error});return i.reject(new n("scenelayer:attribute-request-failed","Request for scene layer attributes failed",{failedAttributes:r}))}for(var s=0,l=a;s<l.length;s++){var c=l[s],f={};for(o=0;o<e.length;o++)null!=e[o].value&&(f[d[o].storageInfo.name]=m(e[o].value,c));t.push(f)}return t})}function m(e,t){var r=e[t];return e instanceof Int16Array?r===A?null:r:e instanceof Int32Array?r===C?null:r:r!=r?null:r}function _(e){for(var t=[],r=0,n=e;r<n.length;r++){var i=n[r];t=t.concat(i)}return t}function b(e){var t=new a(p(e.store.indexCRS||e.store.geographicCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function S(e){var t=new a(p(e.store.vertexCRS||e.store.projectedCRS));return t.equals(e.spatialReference)?e.spatialReference:t}function w(e,t,r){if(!s.canProject(e,t))throw new n("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if("local"===r&&e.isGeographic)throw new n("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{})}function P(e,t,r){var n=b(e),i=S(e);w(n,t,r),w(i,t,r)}function x(e){return"mesh-3d"===e.type}Object.defineProperty(t,"__esModule",{value:!0}),t.DDS_ENCODING_STRING="image/vnd-ms.dds",t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],t.extractWkid=p,t.getAppropriateTextureEncoding=function(e,r){if(Array.isArray(e)){if(r){var n=e.indexOf(t.DDS_ENCODING_STRING);if(n>-1)return n}for(var i=0;i<e.length;i++)if(t.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[i])>-1)return i;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1},t.findIntersectingNodes=function e(t,r,n,i,o,a){if(null!=n){var s=n.mbs;if(r!==i&&(s=I,c.mbsToMbs(n.mbs,i,s,r)),0!==h(t,s)&&(a(n),n.children))for(var u=0;u<n.children.length;++u)e(t,r,o[n.children[u].id],i,o,a)}},t.buildTopNodeMap=function(e,t,r,n){if(void 0===n&&(n=Number.POSITIVE_INFINITY),t<=0)e.clear();else{var i=new Map,o=Number.POSITIVE_INFINITY;e.forEach(function(a,s){var u=r(a);if(s<t)return o=Math.min(o,u),void i.set(a.id,u);if(!(u<=o||u>=n)){i.set(a.id,u);for(var d=o=i.get(e.front().id),l=0,c=1;c<t;++c){var f=e.data[c],p=i.get(f.id);p<o&&(l=c,d=o,o=p)}e.data[l]=a,o=d}}),e.length=Math.min(e.length,t),e.sort(function(e,t){return i.get(t.id)-i.get(e.id)})}};var I=[0,0,0,0];t.intersectBoundingBoxWithMbs=h,t.findFieldsCaseInsensitive=v,t.whenGraphicAttributes=function(e,t,r,o,a,s){var u=!0===(s&&s.populateObjectId),d=s.ignoreUnavailableFields?void 0:[],l=1===o.length&&"*"===o[0];!l&&u&&(o=function(e,t){return e.filter(function(e){return e.toLowerCase()!==t.toLowerCase()}).concat([t])}(o,r));var c=l?o:v(o,e.fields,{missingFields:d});if(d&&0!==d.length)return i.reject(new n("scenelayer:unknown-fields","This scene layer does not have the requested fields",{unknownFields:d}));if(0===t.length)return i.resolve(t);var f=e.associatedLayer,p=e.attributeStorageInfo,h=l?e.fields.map(function(e){return e.name}):c;if(f)return function(e,t,r,n){t.sort(function(e,t){return e.attributes[r]-t.attributes[r]});var i=t.map(function(e){return e.attributes[r]}),o=[],a=v(n,e.fields,{originalFields:o});return g(e,i,a).then(function(e){for(var r=0;r<t.length;r++){var n=t[r],i=e[r];n.attributes={};for(var s=0;s<o.length;s++)n.attributes[o[s]]=i[a[s]]}return t})}(f,t,r,h);var m=function(e,t){for(var r=[],n=0,i=e;n<i.length;n++){var o=i[n];o in t.attributes||r.push(o)}return r}(h,t[0]);if(0===m.length)return i.resolve(t);if(p){var _=a();return null==_?i.reject(new n("scenelayer:feature-not-loaded","Tried to query attributes for unloaded features")):y(p,_.node,_.indices,m,s).then(function(e){for(var r=0;r<t.length;r++){for(var n=0,i=h;n<i.length;n++){var o=i[n];o in e[r]||(e[r][o]=t[r].attributes[o])}t[r].attributes=e[r]}return t})}return i.reject(new n("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var A=-Math.pow(2,15),C=-Math.pow(2,31);t.getCachedAttributeValue=m,t.convertFlatRangesToOffsets=function(e,t,r){void 0===r&&(r=2);for(var i=null!=t?t:e.length/r,o=new Uint32Array(i+1),a=0;a<i;a++){var s=e[a*r],u=3*s;o[a]=u;var d=(a-1)*r+1;if(d>=0&&s-1!==e[d])throw new n("Face ranges are not continuous")}var l=3*(e[(i-1)*r+1]+1);return o[o.length-1]=l,o},t.getIndexCrs=b,t.getVertexCrs=S,t.getCacheKeySuffix=function(e,t){return t===c.SphericalECEFSpatialReference?"@ECEF":e.equals(t)?"":null!=t.wkid?"@"+t.wkid:null},t.checkSpatialReference=w,t.checkSpatialReferences=P,t.checkSceneLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null!=e.geometryType&&"triangles"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{})},t.checkSceneLayerCompatibleWithView=function(e,t){P(e,t.spatialReference,t.viewingMode)},t.checkPointCloudLayerValid=function(e){if(null==e.store||null==e.store.defaultGeometrySchema||!function(e){return!(null==e.geometryType||"points"!==e.geometryType||null!=e.topology&&"PerAttributeArray"!==e.topology||null!=e.encoding&&""!==e.encoding&&"lepcc-xyz"!==e.encoding||null==e.vertexAttributes||null==e.vertexAttributes.position)}(e.store.defaultGeometrySchema))throw new n("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})},t.checkPointCloudLayerCompatibleWithView=function(e,t){w(e.spatialReference,t.spatialReference,t.viewingMode)},t.encodeSymbolColor=f.encodeSymbolColor,t.rendererNeedsTextures=function(e){if(null==e||!function(e){return"simple"===e.type||"class-breaks"===e.type||"unique-value"===e.type}(e))return!0;if(("unique-value"===e.type||"class-breaks"===e.type)&&null==e.defaultSymbol)return!0;var t=e.getSymbols();if(0===t.length)return!0;for(var r=0,n=t;r<n.length;r++){var i=n[r];if(!x(i)||0===i.symbolLayers.length)return!0;for(var o=0,a=i.symbolLayers.items;o<a.length;o++){var s=a[o];if("fill"!==s.type||null==s.material||"replace"!==s.material.colorMixMode)return!0}}return!1}}.apply(null,n))||(e.exports=i)},1669:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(49)],void 0===(i=function(e,t,r){function n(e,t,n,i,o,s,u,d,l,c,f){return function(e,t,n){for(var i=r.vec3d.dist2(e.maxVert[0],e.minVert[0]),o=0,a=1;a<7;++a){var s=r.vec3d.dist2(e.maxVert[a],e.minVert[a]);s>i&&(i=s,o=a)}r.vec3d.set(e.minVert[o],t),r.vec3d.set(e.maxVert[o],n)}(e,i,o),r.vec3d.dist2(i,o)<p?1:(r.vec3d.subtract(i,o,u),r.vec3d.normalize(u),function(e,t,n,i){for(var o=e.data,a=e.offsetIdx,s=e.strideIdx,u=Number.NEGATIVE_INFINITY,d=0,l=a;l<o.length;l+=s){r.vec3d.set3(o[l]-t[0],o[l+1]-t[1],o[l+2]-t[2],x);var c=n[0]*x[0]+n[1]*x[1]+n[2]*x[2],f=r.vec3d.length2(n),p=r.vec3d.length2(x)-c*c/f;p>u&&(u=p,d=l)}return r.vec3d.set3(o[d],o[d+1],o[d+2],i),u}(t,i,u,s)<p?2:(r.vec3d.subtract(o,s,d),r.vec3d.normalize(d),r.vec3d.subtract(s,i,l),r.vec3d.normalize(l),r.vec3d.cross(d,u,n),r.vec3d.normalize(n),a(t,n,u,d,l,c),0))}function i(e,t,n,i,s,u,d,l,c,f){o(e,t,n,i,s,g,y),void 0!==g[0]&&(r.vec3d.subtract(g,n,m),r.vec3d.normalize(m),r.vec3d.subtract(g,i,_),r.vec3d.normalize(_),r.vec3d.subtract(g,s,b),r.vec3d.normalize(b),r.vec3d.cross(_,u,S),r.vec3d.normalize(S),r.vec3d.cross(b,d,w),r.vec3d.normalize(w),r.vec3d.cross(m,l,P),r.vec3d.normalize(P),a(e,S,u,_,m,c),a(e,w,d,b,_,c),a(e,P,l,m,b,c)),void 0!==y[0]&&(r.vec3d.subtract(y,n,m),r.vec3d.normalize(m),r.vec3d.subtract(y,i,_),r.vec3d.normalize(_),r.vec3d.subtract(y,s,b),r.vec3d.normalize(b),r.vec3d.cross(_,u,S),r.vec3d.normalize(S),r.vec3d.cross(b,d,w),r.vec3d.normalize(w),r.vec3d.cross(m,l,P),r.vec3d.normalize(P),a(e,S,u,_,m,c),a(e,w,d,b,_,c),a(e,P,l,m,b,c))}function o(e,t,n,i,o,a,s){!function(e,t,n,i,o){var a=e.data,s=e.offsetIdx,u=e.strideIdx;r.vec3d.set3(a[s],a[s+1],a[s+2],i),r.vec3d.set(i,o),n[0]=r.vec3d.dot(T,t),n[1]=n[0];for(var d=s+u;d<a.length;d+=u){r.vec3d.set3(a[d],a[d+1],a[d+2],T);var l=r.vec3d.dot(T,t);l<n[0]&&(n[0]=l,r.vec3d.set(T,i)),l>n[1]&&(n[1]=l,r.vec3d.set(T,o))}}(e,t,I,s,a);var u=r.vec3.dot(n,t);I[1]-p<=u&&(a[0]=void 0),I[0]+p>=u&&(s[0]=void 0)}function a(e,t,n,i,o,a){if(!(r.vec3d.length2(t)<p)){r.vec3d.cross(n,t,A),r.vec3d.cross(i,t,C),r.vec3d.cross(o,t,R),s(e,t,I),z[1]=I[0],M[1]=I[1],O[1]=M[1]-z[1];for(var u=[n,i,o],d=[A,C,R],l=0;l<3;++l){s(e,u[l],I),z[0]=I[0],M[0]=I[1],s(e,d[l],I),z[2]=I[0],M[2]=I[1],O[0]=M[0]-z[0],O[2]=M[2]-z[2];var c=f(O);c<a.quality&&(r.vec3d.set(u[l],a.b0),r.vec3d.set(t,a.b1),r.vec3d.set(d[l],a.b2),a.quality=c)}}}function s(e,t,r){var n=e.data,i=e.offsetIdx,o=e.strideIdx;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(var a=i;a<n.length;a+=o){var s=n[a]*t[0]+n[a+1]*t[1]+n[a+2]*t[2];r[0]=Math.min(r[0],s),r[1]=Math.max(r[1],s)}}function u(e,t,n){r.vec3d.set(e,n.center),r.vec3d.scale(t,.5,n.halfSize),r.quat4.identity(n.quaternion)}function d(e,t,n){r.vec3d.set(t,N),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?N[0]=0:Math.abs(t[1])>Math.abs(t[2])?N[1]=0:N[2]=0,r.vec3d.length2(N)<p&&(N[0]=N[1]=N[2]=1),r.vec3d.cross(t,N,E),r.vec3d.normalize(E),r.vec3d.cross(t,E,L),r.vec3d.normalize(L),l(e,t,E,L,U,F),r.vec3d.subtract(F,U,k),c(t,E,L,U,F,k,n)}function l(e,t,r,n,i,o){s(e,t,I),i[0]=I[0],o[0]=I[1],s(e,r,I),i[1]=I[0],o[1]=I[1],s(e,n,I),i[2]=I[0],o[2]=I[1]}function c(e,t,n,i,o,a,s){j[0]=e[0],j[3]=e[1],j[6]=e[2],j[1]=t[0],j[4]=t[1],j[7]=t[2],j[2]=n[0],j[5]=n[1],j[8]=n[2],r.quat4.fromRotationMatrix(j,s.quaternion),r.vec3d.add(i,o,B),r.vec3d.scale(B,.5),r.vec3d.scale(e,B[0],s.center),r.vec3d.scale(t,B[1],V),r.vec3d.add(s.center,V),r.vec3d.scale(n,B[2],V),r.vec3d.add(s.center,V),r.vec3d.scale(a,.5,s.halfSize)}function f(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}Object.defineProperty(t,"__esModule",{value:!0});var p=1e-6,h=r.vec3d.create(),v=r.vec3d.create();t.computeOBB=function(e,t){var o=e.data,a=e.strideIdx,s=o.length/a;if(!(s<=0)){var p=new D(e);r.vec3d.add(p.minProj,p.maxProj,h),r.vec3d.scale(h,.5),r.vec3d.subtract(p.maxProj,p.minProj,v);var g=f(v),y=new W;y.quality=g,s<14&&(e={data:new Float64Array(p.buffer,112,42),size:3,offsetIdx:0,strideIdx:3});var m=r.vec3d.create(),_=r.vec3d.create(),b=r.vec3d.create(),S=r.vec3d.create(),w=r.vec3d.create(),P=r.vec3d.create(),x=r.vec3d.create();switch(n(p,e,x,m,_,b,S,w,P,y)){case 1:return void u(h,v,t);case 2:return void d(e,S,t)}i(e,x,m,_,b,S,w,P,y),l(e,y.b0,y.b1,y.b2,U,F);var I=r.vec3d.create();r.vec3d.subtract(F,U,I),y.quality=f(I),y.quality<g?c(y.b0,y.b1,y.b2,U,F,I,t):u(h,v,t)}};var g=r.vec3d.create(),y=r.vec3d.create(),m=r.vec3d.create(),_=r.vec3d.create(),b=r.vec3d.create(),S=r.vec3d.create(),w=r.vec3d.create(),P=r.vec3d.create(),x=r.vec3d.create(),I=r.vec2d.create(),A=r.vec3d.create(),C=r.vec3d.create(),R=r.vec3d.create(),M=r.vec3d.create(),z=r.vec3d.create(),O=r.vec3d.create(),T=r.vec3d.create(),N=r.vec3d.create(),E=r.vec3d.create(),L=r.vec3d.create(),U=r.vec3d.create(),F=r.vec3d.create(),k=r.vec3d.create(),V=r.vec3d.create(),j=r.mat3d.create(),B=r.vec3d.create(),D=function(){return function(e){this.minVert=[],this.maxVert=[],this.buffer=new ArrayBuffer(448);var t=0;for(this.minProj=new Float64Array(this.buffer,t,7),t+=56,this.maxProj=new Float64Array(this.buffer,t,7),t+=56;this.minVert.length<7;)this.minVert.push(new Float64Array(this.buffer,t,3)),t+=24;for(;this.maxVert.length<7;)this.maxVert.push(new Float64Array(this.buffer,t,3)),t+=24;for(var n=0;n<7;++n)this.minProj[n]=Number.POSITIVE_INFINITY,this.maxProj[n]=Number.NEGATIVE_INFINITY;var i=[],o=[],a=e.data,s=e.offsetIdx,u=e.strideIdx;for(n=s;n<a.length;n+=u){var d=a[n];d<this.minProj[0]&&(this.minProj[0]=d,i[0]=n),d>this.maxProj[0]&&(this.maxProj[0]=d,o[0]=n),(d=a[n+1])<this.minProj[1]&&(this.minProj[1]=d,i[1]=n),d>this.maxProj[1]&&(this.maxProj[1]=d,o[1]=n),(d=a[n+2])<this.minProj[2]&&(this.minProj[2]=d,i[2]=n),d>this.maxProj[2]&&(this.maxProj[2]=d,o[2]=n),(d=a[n]+a[n+1]+a[n+2])<this.minProj[3]&&(this.minProj[3]=d,i[3]=n),d>this.maxProj[3]&&(this.maxProj[3]=d,o[3]=n),(d=a[n]+a[n+1]-a[n+2])<this.minProj[4]&&(this.minProj[4]=d,i[4]=n),d>this.maxProj[4]&&(this.maxProj[4]=d,o[4]=n),(d=a[n]-a[n+1]+a[n+2])<this.minProj[5]&&(this.minProj[5]=d,i[5]=n),d>this.maxProj[5]&&(this.maxProj[5]=d,o[5]=n),(d=a[n]-a[n+1]-a[n+2])<this.minProj[6]&&(this.minProj[6]=d,i[6]=n),d>this.maxProj[6]&&(this.maxProj[6]=d,o[6]=n)}for(n=0;n<7;++n){var l=i[n];r.vec3d.set3(a[l],a[l+1],a[l+2],this.minVert[n]),l=o[n],r.vec3d.set3(a[l],a[l+1],a[l+2],this.maxVert[n])}}}(),W=function(){return function(){this.b0=r.vec3d.createFrom(1,0,0),this.b1=r.vec3d.createFrom(0,1,0),this.b2=r.vec3d.createFrom(0,0,1),this.quality=0}}()}.apply(null,n))||(e.exports=i)},1812:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(1737),r(1740),r(1741),r(1564)],void 0===(i=function(e,t,r,n,i,o){function a(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t&&null!=i.attributeValues&&"UInt8"===i.attributeValues.valueType&&3===i.attributeValues.valuesPerElement)return{storageInfo:i,useElevation:!1}}return null}function s(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name===t){var o="embedded-elevation"===i.encoding;return{storageInfo:o?null:i,useElevation:o}}}return"elevation"===t.toLowerCase()?{storageInfo:null,useElevation:!0}:null}function u(e,t,r,n){if(e&&e.useElevation){for(var i=new Float64Array(n),a=0;a<n;a++)i[a]=r[3*a+2];return i}return e&&t?o.readBinaryAttribute(e.storageInfo,t,n):null}function d(e){return null==e||"none"===e?null:"low-four-bit"===e?function(e){return 15&e}:"high-four-bit"===e?function(e){return(240&e)>>4}:"absolute-value"===e?function(e){return Math.abs(e)}:"modulo-ten"===e?function(e){return e%10}:null}Object.defineProperty(t,"__esModule",{value:!0}),t.getRendererInfo=function(e){var t=e.renderer,r=t&&t.type,n=t&&e.renderer.toJSON()||null,i=null,o=!1;"point-cloud-unique-value"===r?i=s(e.attributeStorageInfo,t.field):"point-cloud-stretch"===r?i=s(e.attributeStorageInfo,t.field):"point-cloud-class-breaks"===r?i=s(e.attributeStorageInfo,t.field):o="point-cloud-rgb"===r?null!=(i=a(e.attributeStorageInfo,t.field)):null!=(i=a(e.attributeStorageInfo,"RGB"));var u=null;return t&&t.colorModulation&&(u=s(e.attributeStorageInfo,t.colorModulation.field)),{rendererJSON:n,isRGBRenderer:o,primaryAttribute:i,modulationAttribute:u}},t.evaluateRenderer=function(e,t,o,a,s){var l=e.rendererJSON,c=e.isRGBRenderer,f=e.primaryAttribute,p=e.modulationAttribute,h=u(f,t,a,s),v=u(p,o,a,s),g=null,y=null;if(h&&c)g=h;else if(h&&"pointCloudUniqueValueRenderer"===l.type){var m=(y=i.fromJSON(l)).colorUniqueValueInfos;g=new Uint8Array(3*s);for(var _=d(y.fieldTransformType),b=0;b<s;b++)for(var S=(x=_?_(h[b]):h[b])+"",w=0;w<m.length;w++)if(m[w].values.indexOf(S)>=0){g[3*b]=m[w].color.r,g[3*b+1]=m[w].color.g,g[3*b+2]=m[w].color.b;break}}else if(h&&"pointCloudStretchRenderer"===l.type){var P=(y=n.fromJSON(l)).stops;for(g=new Uint8Array(3*s),_=d(y.fieldTransformType),b=0;b<s;b++){var x=_?_(h[b]):h[b],I=P.length-1;if(x<P[0].value)g[3*b]=P[0].color.r,g[3*b+1]=P[0].color.g,g[3*b+2]=P[0].color.b;else if(x>=P[I].value)g[3*b]=P[I].color.r,g[3*b+1]=P[I].color.g,g[3*b+2]=P[I].color.b;else for(w=1;w<P.length;w++)if(x<P[w].value){var A=(x-P[w-1].value)/(P[w].value-P[w-1].value);g[3*b]=P[w].color.r*A+P[w-1].color.r*(1-A),g[3*b+1]=P[w].color.g*A+P[w-1].color.g*(1-A),g[3*b+2]=P[w].color.b*A+P[w-1].color.b*(1-A);break}}}else if(h&&"pointCloudClassBreaksRenderer"===l.type){var C=(y=r.fromJSON(l)).colorClassBreakInfos;for(g=new Uint8Array(3*s),_=d(y.fieldTransformType),b=0;b<s;b++)for(x=_?_(h[b]):h[b],w=0;w<C.length;w++)if(x>=C[w].minValue&&x<=C[w].maxValue){g[3*b]=C[w].color.r,g[3*b+1]=C[w].color.g,g[3*b+2]=C[w].color.b;break}}else for(g=new Uint8Array(3*s),b=0;b<g.length;b++)g[b]=255;if(v&&y&&y.colorModulation){var R=y.colorModulation.minValue,M=y.colorModulation.maxValue;for(b=0;b<s;b++){var z=(x=v[b])>=M?1:x<=R?.3:.3+.7*(x-R)/(M-R);g[3*b]=z*g[3*b],g[3*b+1]=z*g[3*b+1],g[3*b+2]=z*g[3*b+2]}}return g},t.getSplatSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"splat"===t.type?t:null},t.getFixedSizeAlgorithm=function(e){var t=e&&e.pointSizeAlgorithm;return t&&"fixed-size"===t.type?t:null},t.rendererUsesFixedSizes=function(e){var t=e&&e.pointSizeAlgorithm;return!(!t||!t.type)&&"fixed-size"===t.type}}.apply(null,n))||(e.exports=i)},1847:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(26)],void 0===(i=function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(){this._deferreds=[],this._values=[]}return e.prototype.push=function(e){var t=new r;return this._deferreds.push(t),this._values.push(e),t.promise},e.prototype.length=function(){return this._deferreds.length},e.prototype.process=function(){this._deferreds.shift().resolve(this._values.shift())},e.prototype.cancelAll=function(){for(var e=0,t=this._deferreds;e<t.length;e++)t[e].cancel();this._deferreds.length=0,this._values.length=0},e}();t.IdleQueue=n}.apply(null,n))||(e.exports=i)},2316:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(12),r(0),r(142),r(84),r(21),r(251),r(251),r(15),r(9),r(7),r(255),r(32),r(16),r(253),r(1),r(474),r(68),r(1569),r(1537),r(1461),r(1657),r(1847),r(2317),r(2318),r(1812),r(2319),r(1634),r(49),r(1513),r(1565),r(99),r(1494),r.dj.m(e)],void 0===(i=function(e,t,r,n,i,o,a,s,u,d,l,c,f,p,h,v,g,y,m,_,b,S,w,P,x,I,A,C,R,M,z,O,T,N,E){var L=l.getLogger("esri.views.3d.layers.PointCloudLayerView3D"),U=z.plane.create();return function(t){function l(){var e=null!==t&&t.apply(this,arguments)||this;return e.maximumPointCount=4e6,e._renderer=null,e._rendererAdded=!1,e._renderedNodes=new Set,e._updateViewNeeded=!0,e._idleUpdatesEnabled=!0,e._lodFactor=1,e._worker=new S,e._workerThread=null,e._maxLoggedBoxWarnings=5,e._pageMultiplier=1,e._handles=new d,e._indexQueue=[],e._workQueue=[],e._idleQueue=new P.IdleQueue,e._indexPagesLoading=new Map,e._loadingNodes=new Map,e._layerIsVisible=!1,e._totalWork=0,e._index=null,e._loadingInitNodePage=!1,e._nodeIdArray=[],e}return r(l,t),Object.defineProperty(l.prototype,"pointScale",{get:function(){var e=A.getSplatSizeAlgorithm(this.layer.renderer);return e&&null!=e.scaleFactor?e.scaleFactor:1},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"useRealWorldSymbolSizes",{get:function(){var e=A.getFixedSizeAlgorithm(this.layer.renderer);return!(!e||null==e.useRealWorldSymbolSizes)&&e.useRealWorldSymbolSizes},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"pointSize",{get:function(){var e=A.getFixedSizeAlgorithm(this.layer.renderer);return e&&null!=e.size?e.size:0},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"inverseDensity",{get:function(){return this.layer.renderer?96/this.layer.renderer.pointsPerInch:5},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_clippingBox",{get:function(){var e=y.create(),t=this.view.renderSpatialReference;return T.extentToBoundingBox(this.view.clippingArea,e,t)?e:null},enumerable:!0,configurable:!0}),Object.defineProperty(l.prototype,"_elevationOffset",{get:function(){var e=this.layer.elevationInfo;if(e&&"absolute-height"===e.mode){var t=m.getMetersPerVerticalUnitForSR(this.layer.spatialReference),r=_.getMetersPerUnit(e.unit);return(e.offset||0)*r/t}return 0},enumerable:!0,configurable:!0}),l.prototype.initialize=function(){var t=this;w.checkPointCloudLayerValid(this.layer),w.checkPointCloudLayerCompatibleWithView(this.layer,this.view),this._initRenderer();var r=this._initNodePages(),n={idleBegin:function(){return t._idleBegin()},idleEnd:function(){return t._idleEnd()},needsUpdate:function(){return!0},idleFrame:function(e){return t._process(e)}},i={idleBegin:function(){return t._idleBegin()},idleEnd:function(){return t._idleEnd()},needsUpdate:function(){return t._updateViewNeeded||t._workQueue.length>0},idleFrame:function(e){return t._processWhileSuspended(e)}};v.open(f.getAbsMid("./PointCloudWorker",e,E),{client:this}).then(function(e){t.destroyed?e.close():t._workerThread=e}),this._handles.add(h.init(this,"_clippingBox",function(){return t._setUpdateViewNeeded()})),this._handles.add(h.init(this.layer,"elevationInfo",function(){return t._elevationInfoChanged()})),this._handles.add(h.init(this,"_elevationOffset",function(){return t._elevationOffsetChanged()})),this._handles.add(h.init(this.layer,"renderer",function(){return t._rendererChanged()})),this._handles.add(h.init(this,"clippingArea",function(){t._setUpdateViewNeeded()})),this._handles.add(this.view.state.watch("camera",function(){t._setUpdateViewNeeded()})),this.view.resourceController.memoryEvents.on("quality-changed",function(){return t._setUpdateViewNeeded()}),this.addResolvingPromise(r),this.when(function(){t._handles.add(t.view.resourceController.registerFrameWorker(function(e){return t._frame(e)})),t._handles.add(h.init(t,"suspended",function(e){t._idleFrameWorker&&(t._idleFrameWorker.remove(),t._idleFrameWorker=null),t._idleFrameWorker=e?t.view.resourceController.registerIdleFrameWorker(i):t.view.resourceController.registerIdleFrameWorker(n)}))})},l.prototype._setUpdateViewNeeded=function(){this._updateViewNeeded=!0,this._updateLoading()},l.prototype.destroy=function(){this._cancelNodeLoading(),this._workerThread&&(this._workerThread.close(),this._workerThread=null),this._idleFrameWorker&&(this._idleFrameWorker.remove(),this._idleFrameWorker=null),this._handles.destroy(),this._destroyRenderer()},l.prototype._initRenderer=function(){var e=this;this._renderer=new C,this._renderer.layerUid=this.layer.uid,this._handles.add(h.init(this,"_clippingBox",function(t){e._renderer.clippingBox=t})),this._handles.add(h.init(this,"_clippingBox",function(t){e._renderer.clippingBox=t})),this._handles.add(h.init(this,"suspended",function(t){e._setPointsVisible(!t)})),this._handles.add(h.init(this,"pointScale",function(t){e._renderer.scaleFactor=t})),this._renderer.minSizePx=Math.sqrt(2),this._handles.add(h.init(this,"useRealWorldSymbolSizes",function(t){e._renderer.useRealWorldSymbolSizes=t})),this._handles.add(h.init(this,"pointSize",function(t){var r=p.pt2px(t);e._renderer.size=t,e._renderer.sizePx=r})),this._handles.add(h.init(this,["inverseDensity","maximumPointCount"],function(){e._setUpdateViewNeeded()})),this._handles.add(h.init(this.view,"qualitySettings.sceneService.pointCloud.lodFactor",function(t){e._lodFactor=t,e._setUpdateViewNeeded()}))},l.prototype._destroyRenderer=function(){this._setPointsVisible(!1)},l.prototype._setPointsVisible=function(e){e&&!this._rendererAdded?(this.view._stage.addExternalRenderer([N.OPAQUE_EXTERNAL],this._renderer),this._rendererAdded=!0):!e&&this._rendererAdded&&(this.view._stage.removeExternalRenderer(this._renderer),this._rendererAdded=!1)},l.prototype._rendererChanged=function(){this._clearNodeState(),this._renderer.useFixedSizes=A.rendererUsesFixedSizes(this.layer.renderer),this._setUpdateViewNeeded()},l.prototype._elevationInfoChanged=function(){var e=this.layer.elevationInfo&&this.layer.elevationInfo.unit;e&&!_.supportsUnit(e)&&L.warn("elevationInfo.unit","'"+e+"' is not a valid unit")},l.prototype._elevationOffsetChanged=function(){this._clearNodeState(),this._initNodePages()},l.prototype.displayNodes=function(e){this._workQueue=x.nodeDiff(u.keysOfSet(this._renderedNodes),e,this._index),x.sortFrontToBack(this._workQueue,this.view.state.camera.viewForward,this._index),x.splitWorkEntries(this._workQueue,8,this._index),this._updateQueues(),this._totalWork=this._computeWork(),this._updateLoading(),this._layerIsVisible=e.length>0||this._loadingInitNodePage,this.notifyChange("suspended")},l.prototype.cancelLoading=function(){this._cancelNodeLoading(),this._cancelIndexLoading()},l.prototype._cancelNodeLoading=function(){var e=[];this._loadingNodes.forEach(function(t){return e.push(t)}),this._loadingNodes.clear();for(var t=0,r=e;t<r.length;t++)r[t].cancel();this._workQueue=[],this._idleQueue.cancelAll(),this._totalWork=this._computeWork(),this._updateLoading()},l.prototype._updateQueues=function(){var e=this,t=new Set;this._workQueue.forEach(function(e){e.load.forEach(function(e){t.add(e)})});var r=[],n=new Map;this._loadingNodes.forEach(function(e,i){t.has(i)?n.set(i,e):r.push(e)}),this._loadingNodes=n;for(var i=0,o=r;i<o.length;i++)o[i].cancel();this._workQueue=this._workQueue.filter(function(t){for(var r=0,n=t.load;r<n.length;r++){var i=n[r];if(e._loadingNodes.has(i))return!1}return!0}),this._totalWork=this._computeWork(),this._updateLoading()},l.prototype._cancelIndexLoading=function(){this._indexQueue=[],this._indexPagesLoading.forEach(function(e){return e.cancel()}),this._indexPagesLoading.clear(),this._totalWork=this._computeWork(),this._updateLoading()},l.prototype._clearNodeState=function(){var e=this;this._renderedNodes.forEach(function(t){return e._removeFromRenderer(t)}),this._cancelNodeLoading()},l.prototype._idleBegin=function(){this._setUpdateViewNeeded()},l.prototype._idleEnd=function(){this._setUpdateViewNeeded()},l.prototype._frame=function(e){this.suspended?this._processWhileSuspended(e):this._process(e)},l.prototype._process=function(e){if(this._idleUpdatesEnabled){for(this._updateViewNeeded&&!e.done()&&this._updateWorkQueues();this._indexQueue.length>0&&!e.done();)this._processIndexQueue();for(this._processWorkQueue(e);this._idleQueue.length()>0&&!e.done();)this._idleQueue.process()}},l.prototype._processWhileSuspended=function(e){if(this._idleUpdatesEnabled)for(this._cancelNodeLoading(),this._updateViewNeeded&&!e.done()&&this._updateWorkQueues();this._workQueue.length>0&&!e.done();)this._processWorkQueueRemoveOnly()},l.prototype._processIndexQueue=function(){var e=this,t=this._indexQueue.shift();this._indexPagesLoading.set(t,this._loadNodePage(t)),this._indexPagesLoading.get(t).then(function(r){e._index.addPage(t,r,e._elevationOffset),e._setUpdateViewNeeded()}).always(function(){e._indexPagesLoading.delete(t)})},l.prototype._processWorkQueue=function(e){for(;!e.done();){var t=this._scheduleWorkEntry();if(!t)return;this._processWorkEntry(t)}},l.prototype._scheduleWorkEntry=function(){var e=this;if(this._loadingNodes.size>=8)return null;for(var t=0;t<this._workQueue.length;++t){var r=this._workQueue[t];if(!s.find(r.remove,function(t){return!e._renderedNodes.has(t)})){for(var n=t;n>0;--n)this._workQueue[n]=this._workQueue[n-1];return this._workQueue.shift(),r}}return null},l.prototype._processWorkEntry=function(e){var t=this;if(0!==e.load.length)o(e.load.map(function(e){return t._loadingNodes.has(e)||t._loadingNodes.set(e,t.loadNode(e)),t._loadingNodes.get(e)})).then(function(r){for(var n=0;n<e.load.length;n++)t._addToRenderer(e.load[n],r[n]);for(n=0;n<e.remove.length;n++)t._removeFromRenderer(e.remove[n])}).always(function(){for(var r=0;r<e.load.length;r++)t._loadingNodes.delete(e.load[r]);t._updateLoading()}),this._updateLoading();else for(var r=0;r<e.remove.length;r++)this._removeFromRenderer(e.remove[r])},l.prototype._processWorkQueueRemoveOnly=function(){for(var e=this._workQueue.shift(),t=0;t<e.remove.length;t++)this._removeFromRenderer(e.remove[t]);this._updateLoading()},l.prototype._computeWork=function(){for(var e=0,t=0;t<this._workQueue.length;t++)e+=this._workQueue[t].load.length;return e+=this._loadingNodes.size,e+=(this._indexQueue.length+this._indexPagesLoading.size)*this._index.pageSize,(e+=this._loadingInitNodePage?100:0)+(this._updateViewNeeded?100:0)},Object.defineProperty(l.prototype,"updatingPercentageValue",{get:function(){var e=this._computeWork();return 100*Math.min(this._totalWork,e)/this._totalWork},enumerable:!0,configurable:!0}),l.prototype._updateLoading=function(){this.notifyChange("updating"),this.notifyChange("updatingPercentageValue")},l.prototype.canResume=function(){return this.inherited(arguments)&&this._layerIsVisible},l.prototype.isUpdating=function(){return this._computeWork()>0},l.prototype._initNodePages=function(){var e=this,t=this.layer.store.index,r=t.nodesPerPage||t.nodePerIndexBlock;return this._index=new I(this.layer.spatialReference,this.view.renderCoordsHelper.spatialReference,r),this._cancelIndexLoading(),this._traverseVisible=this._index.createVisibilityTraverse(),this._loadingInitNodePage=!0,this._layerIsVisible=!0,this.notifyChange("suspended"),this._updateLoading(),this._pageMultiplier=null!=t.nodesPerPage?1:t.nodePerIndexBlock,this._loadNodePage(0).then(function(t){e._index.addPage(0,t,e._elevationOffset),e._loadingInitNodePage=!1,e._setUpdateViewNeeded()})},l.prototype._loadNodePage=function(e){var t=this,r=this.baseUrl+"/nodepages/"+e*this._pageMultiplier;return this._requestJSON(r).then(function(r){return r.data.nodes.map(function(r,n){return{resourceId:null!=r.resourceId?r.resourceId:e*t._index.pageSize+n,obb:r.obb,firstChild:r.firstChild,childCount:r.childCount,vertexCount:null!=r.vertexCount?r.vertexCount:r.pointCount,lodThreshold:null!=r.lodThreshold?r.lodThreshold:r.effectiveArea}})})},l.prototype._updateWorkQueues=function(){for(var e=this.inverseDensity/this._lodFactor*this._getLodMemoryFactor(),t=this.maximumPointCount*this._lodFactor*this._getLodMemoryFactor(),r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(n/(.75*t));n>t;)e*=i,r=this._computeNodesForMinimumDensity(e),n=this._computePointCount(r),i=Math.sqrt(2);this.displayNodes(r),this._updateViewNeeded=!1,this._updateLoading()},l.prototype._computePointCount=function(e){for(var t=0,r=0;r<e.length;r++){var n=this._index.getNode(e[r]);n&&(t+=n.vertexCount)}return t},l.prototype._getLodMemoryFactor=function(){return this.view.resourceController.memoryFactor},l.prototype._computeNodesForMinimumDensity=function(e){var t=this,r=this.view.state.camera,n=r.frustumPlanes,i=this._clippingBox,o=r.viewForward,a=M.vec3d.dot(o,r.eye),s=z.plane.fromNormalAndOffset(o,-a,U),u=r.perPixelRatio,d=e*e,l=this._nodeIdArray;return l.length=0,this._traverseVisible({frustumPlanes:n,clippingBox:i},{predicate:function(e,r,n){if(!n)return!1;if(0===r.childCount)return l.push(e),!1;var i=t._index.getRenderObb(e);return!(t._computeAveragePixelArea(i,r.lodThreshold,r.vertexCount,s,u)<=d&&(l.push(e),1))},pageMiss:function(e,r){l.push(e),t._indexQueue.indexOf(r)<0&&t._indexQueue.push(r)}}),l},l.prototype._computeAveragePixelArea=function(e,t,r,n,i){var o=Math.max(1e-7,O.minimumDistancePlane(e,n));return t/(o*o)/(4*i*i)/r},l.prototype.loadNode=function(e){var t=this,r=this._index.getNode(e),n=A.getRendererInfo(this.layer),a=[];return this._idleQueue.push().then(function(){var e=r.resourceId,i=t.loadGeometry(e),s=t.loadAttribute(e,n.primaryAttribute),u=t.loadAttribute(e,n.modulationAttribute);return o(a=[i,s,u])}).then(function(r){var i=r[0],o=r[1],a=r[2],s=[i];o&&s.push(o),a&&s.push(a);var u={geometryBuffer:i,primaryAttribute:o,modulationAttribute:a,schema:t.layer.store.defaultGeometrySchema,rendererInfo:n,obb:t._index.getRenderObb(e),elevationOffset:t._elevationOffset,inSR:t.layer.spatialReference.toJSON(),outSR:t.view.renderCoordsHelper.spatialReference.toJSON()};return t._workerThread?t._workerThread.invoke("process",u,s):c.resolve(t._worker.transform(u))}).catch(function(e){if(e instanceof i)for(var t=0,r=a;t<r.length;t++){r[t].cancel()}else console.error(e);return c.reject(e)})},l.prototype.loadGeometry=function(e){var t=this.baseUrl+"/nodes/"+e+"/geometries/0";return this._requestBinary(t).then(function(e){return e.data})},l.prototype.loadAttribute=function(e,t){if(!t||!t.storageInfo)return c.resolve(null);var r=t.storageInfo.key,n=this.baseUrl+"/nodes/"+e+"/attributes/"+r;return this._requestBinary(n).then(function(e){return e.data})},l.prototype._requestJSON=function(e){return a(e,{query:{f:"json"},responseType:"json"})},l.prototype._requestBinary=function(e){return a(e,{responseType:"array-buffer"})},l.prototype._removeFromRenderer=function(e){this._renderedNodes.has(e)&&(this._renderer.removeNode(""+e),this._renderedNodes.delete(e))},l.prototype._addToRenderer=function(e,t){if(!this._renderedNodes.has(e)){this._renderedNodes.add(e);var r=this._index.getNode(e),n=this._index.getRenderObb(e);(t.obb.halfSize[0]>n.halfSize[0]||t.obb.halfSize[1]>n.halfSize[1]||t.obb.halfSize[2]>n.halfSize[2])&&(this._maxLoggedBoxWarnings>0&&(L.warn("Node",e,"reported bounding box too small, got",n,"but points cover",t.obb),0==--this._maxLoggedBoxWarnings&&L.warn("  Too many bounding box errors, stopping reporting for this layer.")),this._index.setRenderObb(e,t.obb));var i=Math.sqrt(r.lodThreshold/r.vertexCount);this._renderer.addNode({id:""+e,coordinates:t.points,origin:n.center,rgb:t.rgb,splatSize:i,obb:n,isLeaf:0===r.childCount})}},l.prototype.removeCachedData=function(){var e=this;this.suspended&&this._renderedNodes.forEach(function(t){return e._removeFromRenderer(t)})},l.prototype.getCachedMemory=function(){return 0},l.prototype.getUsedMemory=function(){var e=this;return u.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+15*e._index.getNode(r).vertexCount+128},0)/1024/1024},l.prototype.getUnloadedMemory=function(){var e=this,t=this._renderedNodes.size;if(t<4)return 0;for(var r=u.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount}),n=this._loadingNodes.size,i=0;i<this._workQueue.length;i++)n+=this._workQueue[i].load.length,n-=this._workQueue[i].remove.length;return n<0?0:(n*r/t*15+128*n)/1024/1024},l.prototype.getStats=function(){var e=this;return{"Rendered Nodes":this._renderedNodes.size,"Rendered Points":u.keysOfSet(this._renderedNodes).reduce(function(t,r){return t+e._index.getNode(r).vertexCount},0),"Loading Nodes":this._loadingNodes.size,"Index Queue":this._indexQueue.length,"Work Queue":this._workQueue.length,"Idle Queue":this._idleQueue.length()}},n([g.property()],l.prototype,"layer",void 0),n([g.property({readOnly:!0,aliasOf:"layer.parsedUrl.path"})],l.prototype,"baseUrl",void 0),n([g.property({readOnly:!0,dependsOn:["layer.renderer"]})],l.prototype,"pointScale",null),n([g.property({readOnly:!0,dependsOn:["layer.renderer"]})],l.prototype,"useRealWorldSymbolSizes",null),n([g.property({readOnly:!0,dependsOn:["layer.renderer"]})],l.prototype,"pointSize",null),n([g.property({readOnly:!0,dependsOn:["layer.renderer"]})],l.prototype,"inverseDensity",null),n([g.property()],l.prototype,"maximumPointCount",void 0),n([g.property({readOnly:!0,dependsOn:["view.clippingArea"]})],l.prototype,"_clippingBox",null),n([g.property({readOnly:!0,dependsOn:["layer.elevationInfo"]})],l.prototype,"_elevationOffset",null),n([g.property(R.updatingPercentage)],l.prototype,"updatingPercentage",void 0),n([g.property({readOnly:!0})],l.prototype,"updatingPercentageValue",null),n([g.subclass("esri.views.3d.layers.PointCloudLayerView3D")],l)}(g.declared(b))}.apply(null,n))||(e.exports=i)},2317:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(49)],void 0===(i=function(e,t,r){function n(e,t,r){for(var n=e;n>0;){var i=t.indexOf(n);if(i>=0)return i;n=r.getParentId(n)}return t.indexOf(n)}function i(e,t){for(var r=[e.remove[0]],n=[];1===r.length;){var i=r.pop();n.length=0;for(var o=0;o<e.load.length;o++){for(var a=e.load[o],s=t.getParentId(a);s!==i;)a=s,s=t.getParentId(a);var u=r.indexOf(a);u<0&&(u=r.length,r.push(a),n.push([])),n[u].push(e.load[o])}}var d=[];d.push({remove:e.remove,load:r});for(o=0;o<r.length;o++)n[o].length>1?d.push({remove:[r[o]],load:n[o]}):r[o]=n[o][0];return d}Object.defineProperty(t,"__esModule",{value:!0}),t.nodeDiff=function(e,t,r){for(var i=0;i<t.length;i++)s[i]=!1,u[i]=null;for(i=0;i<e.length;i++)o[i]=!1,a[i]=null;for(i=0;i<t.length;i++)(d=n(t[i],e,r))>=0&&(s[i]=!0,null!=a[d]?a[d].push(t[i]):a[d]=[t[i]]);for(i=0;i<e.length;i++){var d;(d=n(e[i],t,r))>=0&&(o[i]=!0,null!=u[d]?u[d].push(e[i]):u[d]=[e[i]])}var l=[];for(i=0;i<e.length;i++)null!=a[i]||o[i]||l.push({load:[],remove:[e[i]]});for(i=0;i<t.length;i++)null!=u[i]||s[i]||l.push({load:[t[i]],remove:[]});for(i=0;i<t.length;i++)null!=u[i]&&(u[i].length>1||u[i][0]!==t[i])&&l.push({load:[t[i]],remove:u[i]});for(i=0;i<e.length;i++)null!=a[i]&&(a[i].length>1||a[i][0]!==e[i])&&l.push({load:a[i],remove:[e[i]]});return l};var o=[!1],a=[null],s=[!1],u=[null];t.sortFrontToBack=function(e,t,n){return e.sort(function(e,i){if(0===e.load.length&&0===i.load.length)return 0;if(0===e.load.length)return-1;if(0===i.load.length)return 1;if(0===e.remove.length&&0===i.remove.length){var o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]);return r.vec3d.dot(o,t)-r.vec3d.dot(a,t)}return 0===e.remove.length?-1:0===i.remove.length?1:1===e.load.length&&1===i.load.length?(o=n.getRenderCenter(e.load[0]),a=n.getRenderCenter(i.load[0]),r.vec3d.dot(o,t)-r.vec3d.dot(a,t)):1===e.load.length?-1:1===i.load.length?1:(o=n.getRenderCenter(e.remove[0]),a=n.getRenderCenter(i.remove[0]),r.vec3d.dot(o,t)-r.vec3d.dot(a,t))})},t.splitWorkEntries=function(e,t,r){for(var n=0;n<e.length;++n){var o=e[n];if(o.load.length>t&&1===o.remove.length){var a=i(o,r);e[n]=a[0];for(var s=1;s<a.length;s++)e.push(a[s])}}},t.splitWorkEntry=i}.apply(null,n))||(e.exports=i)},2318:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(474),r(49),r(1565),r(99)],void 0===(i=function(e,t,r,n,i,o){function a(e,t,n){var o=e.index;if(o.hasNodes(0,1)){var a=e.queue;a.length=0,a.push(0);var s=e.masks;for(s.length=0,s.push(0);a.length>0;){var d=a.pop(),l=s.pop(),c=o.getNode(d),f=o.getRenderObb(d),p=!0;if(null!=t.clippingBox)if(0==(l&(g=1<<t.frustumPlanes.length))){var h=i.toAaBoundingBox(f,e.tempAabb);r.contains(t.clippingBox,h)?l|=g:r.intersects(t.clippingBox,h)||(p=!1)}for(var v=0;v<t.frustumPlanes.length&&p;v++){var g;if(0==(l&(g=1<<v))){var y=i.intersectPlane(f,t.frustumPlanes[v]);y>0?p=!1:y<0&&(l|=g)}}if(n.predicate(d,c,p)){for(var m=c.firstChild,_=c.childCount,b=!1,S=u(m,o.pageSize),w=u(m+_-1,o.pageSize),P=S;P<=w;P++)if(!o.hasPage(P)){n.pageMiss(d,P),b=!0;break}if(!b)for(v=0;v<_;v++)a.push(m+v),s.push(l)}}}}function s(e,t,r,a){for(var s=new i.ObbArray(e.length),u=0;u<e.length;u++){var d=e[u].obb,c=s.obbs[u];if(i.set(d,c),n.vec3.set3(d.center[0],d.center[1],d.center[2]+a,l),!t.isGeographic&&r===o.SphericalECEFSpatialReference){o.computeLinearTransformation(t,l,f,r);var h=2*Math.sqrt(1+f[0]+f[5]+f[10]);p[0]=(f[9]-f[6])/h,p[1]=(f[2]-f[8])/h,p[2]=(f[4]-f[1])/h,p[3]=.25*h,n.quat4.conjugate(p),n.quat4.multiply(p,c.quaternion,c.quaternion)}o.bufferToBuffer(l,t,0,c.center,r,0,1)}return s.obbs}function u(e,t){return e/t|0}function d(e,t){return e%t}var l=n.vec3d.create(),c=function(){function e(e,t,r){this._pages=[],this.pageSize=0,this._nodeSR=null,this._renderSR=null,this._nodeSR=e,this._renderSR=t,this.pageSize=r}return e.prototype.addPage=function(e,t,r){for(void 0===r&&(r=0);this._pages.length<e;)this._pages.push(null);var n=s(t,this._nodeSR,this._renderSR,r);this._pages[e]={nodes:t,renderObbs:n,parents:new Uint32Array(this.pageSize)},function(e,t){for(var r=[0];r.length;)for(var n=r.pop(),i=e[u(n,t)].nodes[d(n,t)],o=0;o<i.childCount;o++){var a=i.firstChild+o;null!=e[u(a,t)]&&(e[u(a,t)].parents[d(a,t)]=n,r.push(a))}}(this._pages,this.pageSize)},e.prototype.hasPage=function(e){return!!this._pages[e]},e.prototype.getNode=function(e){var t=this.pageSize;return this._pages[u(e,t)].nodes[d(e,t)]},e.prototype.getRenderObb=function(e){var t=this.pageSize;return this._pages[u(e,t)].renderObbs[d(e,t)]},e.prototype.getRenderCenter=function(e){return this.getRenderObb(e).center},e.prototype.setRenderObb=function(e,t){var r=this.pageSize;i.set(t,this._pages[u(e,r)].renderObbs[d(e,r)])},e.prototype.getParentId=function(e){var t=this.pageSize;return this._pages[u(e,t)].parents[d(e,t)]},e.prototype.hasNodes=function(e,t){for(var r=u(e,this.pageSize),n=u(e+t-1,this.pageSize),i=r;i<=n;i++)if(null==this._pages[i])return!1;return!0},e.prototype.createVisibilityTraverse=function(){var e={index:this,queue:[],masks:[],tempAabb:r.create()};return function(t,r){return a(e,t,r)}},e}(),f=n.mat4d.create(),p=n.quat4.create();return c}.apply(null,n))||(e.exports=i)},2319:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r(2320),r(474),r(1513),r(1565),r(1491),r(1510),r(1500),r(1496),r(1499)],void 0===(i=function(e,t,r,n,i,o,a,s,u,d,l){function c(e){return e?256:64}function f(e,t,r,n,i){if(r.drawScreenSpace)return r.fixedSize*t*n;var o=c(i)*t*n;return r.drawFixedSize?Math.min(r.fixedSize/2,o):r.screenMinSize>0?Math.min(Math.max(r.screenMinSize*t*n,e/2),o):Math.min(e/2,o)}function p(e,t,r,n,i){return r.drawScreenSpace?0:f(e,t,r,n,i)}function h(e,t,r){return null==r&&(r=a.vec3d.create()),r[0]=e.origin[0]+e.coordinates[3*t],r[1]=e.origin[1]+e.coordinates[3*t+1],r[2]=e.origin[2]+e.coordinates[3*t+2],r}var v={aPosition:0,aColor:1},g={positions:[{name:"aPosition",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"aColor",count:3,type:5121,offset:0,stride:3,normalized:!0}]};return function(){function e(){this.didRender=!1,this.needsRender=!0,this.layerUid="",this._useFixedSizes=!1,this._scaleFactor=1,this._minSizePx=0,this._useRealWorldSymbolSizes=!1,this._size=0,this._sizePx=0,this._clipBox=n.create(n.POSITIVE_INFINITY),this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null,this.tempMatrix4=a.mat4.create(),this.tempVec3=a.vec3.create(),this.nodes=[]}return e.prototype.initializeRenderContext=function(e){e.shaderSnippets.fsPointCloudPointRenderer||e.shaderSnippets._parse(r);var t=e.shaderSnippets.vsPointCloudPointRenderer,n=e.shaderSnippets.fsPointCloudPointRenderer;this._programWorld=new d(e.rctx,t,n,v,[]),this._programScreen=new d(e.rctx,t,n,v,["DRAW_SCREEN_SIZE"]),this._programWorldDepth=new d(e.rctx,t,n,v,["DEPTH_PASS"]),this._programScreenDepth=new d(e.rctx,t,n,v,["DRAW_SCREEN_SIZE","DEPTH_PASS"]),this.needsRender=!0},e.prototype.uninitializeRenderContext=function(e){this._programWorld&&this._programWorld.dispose(),this._programScreen&&this._programScreen.dispose(),this._programWorldDepth&&this._programWorldDepth.dispose(),this._programScreenDepth&&this._programScreenDepth.dispose(),this._programWorld=null,this._programScreen=null,this._programWorldDepth=null,this._programScreenDepth=null},e.prototype.intersect=function(e,t,r,s){var u=a.vec3d.create(),d=a.vec3d.create(),l=a.vec3d.create(),c=a.vec3d.create(),v=i.plane.create(),g=e.camera.perPixelRatio,y=e.camera.near,m=this._getSizeParams();a.vec3d.subtract(r,t,d);var _=1/a.vec3d.length(d);a.vec3d.scale(d,_,d),a.vec3d.negate(d,l),a.vec4d.set4(d[0],d[1],d[2],-a.vec3d.dot(d,t),v);var b={},S={},w=n.create(),P=n.create(this._clipBox);n.offset(P,-t[0],-t[1],-t[2],P);for(var x=0,I=this.nodes;x<I.length;x++){var A=I[x],C=A.splatSize*this._scaleFactor,R=o.minimumDistancePlane(A.obb,v),M=o.maximumDistancePlane(A.obb,v);R-=p(C,R+y,m,g,A.isLeaf);var z=(M-=p(C,M+y,m,g,A.isLeaf))<0,O=null!=b.dist&&null!=S.dist&&b.dist<R*_&&S.dist>M*_;if(!z&&!O){var T=f(C,M+y,m,g,A.isLeaf);if(o.intersectLine(A.obb,t,d,T)){var N=T*T;o.toAaBoundingBox(A.obb,w),n.offset(w,-t[0],-t[1],-t[2],w);var E=!n.contains(P,w);a.vec3d.subtract(A.origin,t,c);for(var L=0;L<A.pointCount;L++)if(u[0]=c[0]+A.coordinates[3*L],u[1]=c[1]+A.coordinates[3*L+1],u[2]=c[2]+A.coordinates[3*L+2],!E||n.containsPoint(P,u)){var U=a.vec3d.dot(u,d),F=U+y,k=p(C,F,m,g,A.isLeaf);if(!(U-k<0)){var V=a.vec3d.length2(u)-U*U;if(!(V>N)){var j=f(C,F-=k,m,g,A.isLeaf);if(!(V>j*j)){var B=this.layerUid+"/"+A.id+"/"+L,D=(U-k)*_;(null==b.dist||D<b.dist)&&(b.point=h(A,L,b.point),b.dist=D,b.normal=l,b.pointId=B,b.layerUid=this.layerUid),(null==S.dist||D>S.dist)&&(S.point=h(A,L,S.point),S.dist=D,S.normal=l,S.pointId=B,S.layerUid=this.layerUid)}}}}}}}if(null!=b.dist){var W=e.getMinResult();if(null==W.dist||b.dist<W.dist){var q={type:"external",point:b.point,metadata:{pointId:b.pointId,layerUid:b.layerUid}};W.set(q,b.pointId,b.dist,b.normal,void 0),W.setIntersector("PointRenderer")}}if(null!=S.dist){var H=e.getMaxResult();if(null==H.dist||S.dist>H.dist){q={type:"external",point:S.point,metadata:{pointId:S.pointId,layerUid:S.layerUid}};H.set(q,S.pointId,S.dist,S.normal,void 0),H.setIntersector("PointRenderer")}}},e.prototype.render=function(e){if(e.pass!==s.MATERIAL&&e.pass!==s.MATERIAL_DEPTH)return!1;for(var t=e.pass===s.MATERIAL_DEPTH,r=e.rctx,i=0,o=this.nodes;i<o.length;i++){null==(g=o[i]).vao&&this._initNode(e,g)}var u=this._getSizeParams(),d=t?u.drawScreenSpace?this._programScreenDepth:this._programWorldDepth:u.drawScreenSpace?this._programScreen:this._programWorld;if(null==d||0===this.nodes.length)return!0;var l=this._clipBox,f=!n.equals(l,n.POSITIVE_INFINITY,function(e,t){return e===t});f||(a.vec3.set3(-1/0,-1/0,-1/0,this.tempVec3),d.setUniform3fv("uClipMin",this.tempVec3),a.vec3.set3(1/0,1/0,1/0,this.tempVec3),d.setUniform3fv("uClipMax",this.tempVec3)),r.setDepthTestEnabled(!0),r.bindProgram(d);var p=e.camera.projectionMatrix;d.setUniformMatrix4fv("uProjectionMatrix",p),t&&d.setUniform2f("nearFar",e.camera.near,e.camera.far),u.drawFixedSize&&d.setUniform2f("uPointScale",u.fixedSize,e.camera.fullHeight);for(var h=0,v=this.nodes;h<v.length;h++){var g=v[h];if(d.setUniform2f("uScreenMinMaxSize",u.screenMinSize,c(g.isLeaf)),!u.drawFixedSize){var y=g.splatSize*this._scaleFactor;d.setUniform2f("uPointScale",y,e.camera.fullHeight)}var m=g.origin;f&&(a.vec3.set3(l[0]-m[0],l[1]-m[1],l[2]-m[2],this.tempVec3),d.setUniform3fv("uClipMin",this.tempVec3),a.vec3.set3(l[3]-m[0],l[4]-m[1],l[5]-m[2],this.tempVec3),d.setUniform3fv("uClipMax",this.tempVec3)),a.mat4.identity(this.tempMatrix4),a.mat4.translate(this.tempMatrix4,m,this.tempMatrix4),a.mat4.multiply(e.camera.viewMatrix,this.tempMatrix4,this.tempMatrix4),d.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4),r.bindVAO(g.vao),r.drawArrays(0,0,g.pointCount)}return!0},Object.defineProperty(e.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(e){this._useFixedSizes!==e&&(this._useFixedSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(e){this._scaleFactor!==e&&(this._scaleFactor=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"minSizePx",{get:function(){return this._minSizePx},set:function(e){this._minSizePx!==e&&(this._minSizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(e){this._useRealWorldSymbolSizes!==e&&(this._useRealWorldSymbolSizes=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"size",{get:function(){return this._size},set:function(e){this._size!==e&&(this._size=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"sizePx",{get:function(){return this._sizePx},set:function(e){this._sizePx!==e&&(this._sizePx=e,this._requestRender())},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"clippingBox",{set:function(e){n.set(this._clipBox,e||n.POSITIVE_INFINITY)},enumerable:!0,configurable:!0}),e.prototype.addNode=function(e){this.nodes.push({id:e.id,splatSize:e.splatSize,obb:e.obb,origin:a.vec3.create(e.origin),coordinates:e.coordinates,pointCount:e.coordinates.length/3,rgb:e.rgb,vao:null,isLeaf:e.isLeaf}),this._requestRender()},e.prototype.removeNode=function(e){this.nodes=this.nodes.filter(function(t){return t.id===e&&t.vao&&(t.vao.dispose(!0),t.vao=null),t.id!==e}),this._requestRender()},e.prototype.removeAll=function(){this.nodes.forEach(function(e){e.vao&&(e.vao.dispose(!0),e.vao=null)}),this.nodes=[],this._requestRender()},e.prototype._initNode=function(e,t){var r=e.rctx;t.vao=new l(r,v,g,{positions:u.createVertex(r,35044,t.coordinates),colors:u.createVertex(r,35044,t.rgb)})},e.prototype._requestRender=function(){this.didRender=!1,this.needsRender=!0},e.prototype._getSizeParams=function(){var e=this._useFixedSizes,t=e&&!this._useRealWorldSymbolSizes,r=t?this._sizePx:this._size,n=this._minSizePx;return e&&(n=0),{drawScreenSpace:t,drawFixedSize:e,fixedSize:r,screenMinSize:n}},e}()}.apply(null,n))||(e.exports=i)},2320:function(e,t){e.exports='<?xml version="1.0" encoding="UTF-8"?>\n\n<snippets>\n\n<snippet name="vsPointCloudPointRenderer"><![CDATA[\n$vsprecisionf\n\nattribute vec3 aPosition;\nattribute vec3 aColor;\n\nuniform mat4 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\nuniform vec2 uScreenMinMaxSize;\nuniform vec2 uPointScale;\nuniform vec3 uClipMin;\nuniform vec3 uClipMax;\n\n#ifdef DEPTH_PASS\nuniform vec2 nearFar;\n\nvarying float depth;\n#else\nvarying vec3 vColor;\n#endif\n\nvoid main(void) {\n\n  // Move clipped points outside of clipspace\n  if (aPosition.x < uClipMin.x || aPosition.y < uClipMin.y || aPosition.z < uClipMin.z ||\n      aPosition.x > uClipMax.x || aPosition.y > uClipMax.y || aPosition.z > uClipMax.z) {\n    gl_Position = vec4(0.0,0.0,0.0,2.0);\n    gl_PointSize = 0.0;\n    return;\n  }\n\n  // Position in camera space\n  vec4 camera = uModelViewMatrix * vec4(aPosition, 1.0);\n\n  float pointSize = uPointScale.x;\n  vec4 position = uProjectionMatrix * camera;\n\n  // Calculate Size\n  #ifdef DRAW_SCREEN_SIZE\n    float clampedScreenSize = pointSize;\n  #else\n    float pointRadius = 0.5 * pointSize;\n    vec4 cameraOffset = camera + vec4(0.0, pointRadius, 0.0, 0.0);\n    vec4 positionOffset = uProjectionMatrix * cameraOffset;\n    float radius = abs(positionOffset.y - position.y);\n\n    float viewHeight = uPointScale.y;\n\n    // screen diameter = (2 * r / w) * (h / 2)\n    float screenPointSize = (radius / position.w) * viewHeight;\n    float clampedScreenSize = clamp(screenPointSize, uScreenMinMaxSize.x, uScreenMinMaxSize.y);\n\n    // Shift towards camera, to move rendered point out of terrain i.e. to\n    // the camera-facing end of the virtual point when considering it as a\n    // 3D sphere.\n    camera.xyz -= normalize(camera.xyz) * pointRadius * clampedScreenSize / screenPointSize;\n    position = uProjectionMatrix * camera;\n  #endif\n\n  gl_PointSize = clampedScreenSize;\n  gl_Position = position;\n\n  #ifdef DEPTH_PASS\n  depth = (-camera.z - nearFar[0]) / (nearFar[1] - nearFar[0]);\n  #else\n  vColor = aColor;\n  #endif\n}\n]]></snippet>\n\n<snippet name="fsPointCloudPointRenderer"><![CDATA[\n$fsprecisionf\n\n#ifdef DEPTH_PASS\n$float2rgba\n\nvarying float depth;\n#else\nvarying vec3 vColor;\n#endif\n\nvoid main(void) {\n  vec2 vOffset = gl_PointCoord - vec2(0.5, 0.5);\n  float r2 = dot(vOffset, vOffset);\n\n  if (r2 > 0.25) {\n    discard;\n  }\n\n  #ifdef DEPTH_PASS\n  gl_FragColor = float2rgba(depth);\n  #else\n  gl_FragColor = vec4(vColor, 1.0);\n  #endif\n}\n]]></snippet>\n\n</snippets>\n'}}]);